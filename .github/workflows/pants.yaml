name: CI

on: 
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to staging'
        required: true
        type: boolean

jobs:
  build:
    name: static analysis
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        python-version: [3.9]
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - uses: pantsbuild/actions/init-pants@v8
      with:
        gha-cache-key: v0
        named-caches-hash: ${{ hashFiles('python-default.lock') }}
        cache-lmdb-store: 'true'  # defaults to 'false'
    - name: Check pants version
      run: pants --version
    - name: Check BUILD files
      run: |
        pants tailor --check update-build-files --check ::
    - name: Static Analysis
      run: | 
        pants \
        --changed-since=origin/main \
        tailor --check \
        update-build-files --check \
        lint
    - name: Unit Test
      # Run tests for all targets that have changed since the last commit on main
      # also with dependency change with --changed-dependents
      run: |
        pants \
        --changed-since=origin/main \
        --changed-dependents=transitive \
        test ::
  deploy:
    name: deploy
    needs: build
    if: |
      (startsWith(github.ref, 'ref/heads/release/') && 
      github.event_name == 'workflow_dispatch' && 
      inputs.deploy == true)
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        python-version: [3.9]
    steps:
      - name: Deploy
        id: deploy
        run: |
          echo "Deploying to staging"
      